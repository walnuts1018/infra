apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: blackbox-exporter-helm
  namespace: argocd
spec:
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: prometheus-blackbox-exporter
    helm:
      releaseName: blackbox-exporter
      values: |
        serviceMonitor:
          selfMonitor:
            enabled: true
          enabled: true
          targets:
          - name: "walnuts-dev"
            url: "https://walnuts.dev/healthz"
          - name: "http-test"
            url: "https://httptest.walnuts.dev/"
          - name: "blog"
            url: "https://blog.walnuts.dev/"
          - name: "grafana"
            url: "https://grafana.walnuts.dev/healthz"
          - name: "oekaki-dengon-game"
            url: "https://oekaki.walnuts.dev/public"
          - name: "misskey"
            url: "https://misskey.walnuts.dev/healthz"
          - name: "minio"
            url: "https://minio.walnuts.dev/minio/health/live"
          - name: "nextcloud"
            url: "https://nextcloud.walnuts.dev/status.php"
          - name: "zitadel"
            url: "https://auth.walnuts.dev/healthz"

        resources:
          requests:
            cpu: 2m
            memory: 39Mi
          limits:
            memory: 300Mi
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 11.4.1
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - FailOnSharedResource=true
