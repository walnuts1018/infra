apiVersion: v1
data:
  setup.sh: "#!/bin/bash\nset -e\n\nSCYLLA_PORT=\"${SCYLLA_PORT:-9142}\"\nMAX_RETRIES=\"${MAX_RETRIES:-60}\" # 10åˆ†\nRETRY_INTERVAL=\"${RETRY_INTERVAL:-10}\"\nADMIN_CERTS_DIR=\"${ADMIN_CERTS_DIR:-/certs/admin}\"\nCA_CERTS_DIR=\"${CA_CERTS_DIR:-/certs/ca}\"\nSCHEMA_FILE=\"${SCHEMA_FILE:-/config/migrations.cql}\"\nSCYLLA_ADMIN_USER=\"${SCYLLA_ADMIN_USER:-cassandra}\"\nSCYLLA_ADMIN_PASSWORD=\"${SCYLLA_ADMIN_PASSWORD:-cassandra}\"\n\nlog() {\n    local level=\"$1\"\n    local msg=\"$2\"\n    local timestamp\n    timestamp=$(date '+%Y-%m-%dT%H:%M:%S%z')\n    \n    shift 2\n    local json=\"{\\\"level\\\":\\\"$level\\\",\\\"time\\\":\\\"$timestamp\\\",\\\"msg\\\":\\\"$msg\\\"\"\n    while [[ $# -gt 0 ]]; do\n        json+=\",\\\"$1\\\":\\\"$2\\\"\"\n        shift 2\n    done\n    echo \"$json}\"\n}\n\nsetup_cqlshrc_config() {\n    local cqlshrc_path=\"$1\"\n\n\n    cat > \"${cqlshrc_path}.credentials\" <<EOF\n[PlainTextAuthProvider]\nusername = ${SCYLLA_ADMIN_USER}\npassword = ${SCYLLA_ADMIN_PASSWORD}\nEOF\n    chmod 600 \"${cqlshrc_path}.credentials\"\n\n    cat > \"${cqlshrc_path}\" <<EOF\n[connection]\nhostname = ${SCYLLA_HOST}\nport = ${SCYLLA_PORT}\nssl = true\nfactory = cqlshlib.ssl.ssl_transport_factory\n\n[ssl]\nvalidate = true\ncertfile = /certs/ca/ca-bundle.crt\nusercert = /certs/admin/tls.crt\nuserkey = /certs/admin/tls.key\n\n[authentication]\ncredentials = ${cqlshrc_path}.credentials\nEOF\n}\n\nwait_for_cluster() {\n    local cqlshrc=\"$1\"\n    local retries=0\n\n    log \"info\" \"Waiting for ScyllaDB cluster to be ready...\"\n    \n    while [ $retries -lt $MAX_RETRIES ]; do\n    if cqlsh --cqlshrc=\"${cqlshrc}\" -e \"DESCRIBE CLUSTER\" 2>/dev/null; then\n        log \"info\" \"ScyllaDB cluster is ready!\"\n        return 0\n    fi\n    \n    retries=$((retries + 1))\n    log \"info\" \"Attempt ${retries}/${MAX_RETRIES}:  Cluster not ready yet.  Waiting ${RETRY_INTERVAL}s...\"\n    sleep $RETRY_INTERVAL\n    done\n\n    log \"error\" \"Timeout waiting for ScyllaDB cluster\"\n    exit 1\n}\n\n\nmigration() {\n    local cqlshrc=\"$1\"\n    \n    log \"info\" \"Applying migrations from ${SCHEMA_FILE}...\"\n    cqlsh --cqlshrc=\"${cqlshrc}\" -f \"${SCHEMA_FILE}\"\n    log \"info\" \"Migrations applied successfully.\"\n}\n\nlog \"info\" \"Preparing temporary directory...\"\nmkdir -p /tmp/cqlsh\n\nlog \"info\" \"Starting ScyllaDB setup process\"\nsetup_cqlshrc_config \"/tmp/cqlsh/default.cqlshrc\"\n\nlog \"info\" \"Waiting for cluster...\"\nwait_for_cluster \"/tmp/cqlsh/default.cqlshrc\"\n\nlog \"info\" \"Running migrations...\"\nmigration \"/tmp/cqlsh/default.cqlshrc\"\n\nlog \"info\" \"Final verification...\"\nlog \"info\" \"Listing all roles:\"\ncqlsh --cqlshrc=\"/tmp/cqlsh/default.cqlshrc\" -e \"LIST ROLES;\"\n\nlog \"info\" \"Listing all keyspaces:\"\ncqlsh --cqlshrc=\"/tmp/cqlsh/default.cqlshrc\" -e \"DESCRIBE KEYSPACES;\"\n\nlog \"info\" \"ScyllaDB setup process completed successfully!\"\n"
kind: ConfigMap
metadata:
  labels: {}
  name: scylla-setup-09ebf4
  namespace: databases
