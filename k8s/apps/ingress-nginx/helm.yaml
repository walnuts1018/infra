apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ingress-nginx-helm
  namespace: argocd
spec:
  destination:
    namespace: ingress-nginx
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: ingress-nginx
    helm:
      releaseName: ingress-nginx
      values: |
        controller:
          config:
            use-forwarded-headers: true
            enable-opentelemetry: "true"
            opentelemetry-trust-incoming-span: "true"
            otlp-collector-host: "default-collector.opentelemetry-collector.svc.cluster.local"
            otel-service-name: "ingress-nginx"
            log-format-upstream: '{"time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for", "request_id": "$req_id",  "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent" }'
            proxy-body-size: 0
          service:
            enabled: true
            loadBalancerIP: "192.168.0.128"
            loadBalancerSourceRanges: []
            enableHttp: false
            enableHttps: true
            type: LoadBalancer
          replicaCount: 3
          affinity:
            nodeAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                    - amd64
          opentelemetry:
            enabled: true
            name: opentelemetry
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
          # extraArgs:
          #   enable-ssl-passthrough: "true"
          resources:
            requests:
              cpu: 4m
              memory: 128Mi
            limits:
              cpu: 100m
              memory: 256Mi
    repoURL: https://kubernetes.github.io/ingress-nginx
    targetRevision: 4.13.3
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - FailOnSharedResource=true
