apiVersion: batch/v1
kind: CronJob
metadata:
  labels:
    app: fitbit-manager
    app.kubernetes.io/name: fitbit-manager
  name: fitbit-manager
  namespace: fitbit-manager
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - command:
                - /app/fitbit-manager-job
              env:
                - name: USER_ID
                  value: B84M2S
                - name: SERVER_URL
                  value: https://fitbit.walnuts.dev/
                - name: CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: fitbit-manager-f1058b
                - name: CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: fitbit-manager-f1058b
                - name: COOKIE_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: cookie_secret
                      name: fitbit-manager-f1058b
                - name: PSQL_HOST
                  value: postgresql-default-rw.databases.svc.cluster.local
                - name: PSQL_PORT
                  value: "5432"
                - name: PSQL_DATABASE
                  value: fitbit_manager
                - name: PSQL_USER
                  value: fitbit_manager
                - name: PSQL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: postgres_password
                      name: fitbit-manager-f1058b
                - name: INFLUXDB_ENDPOINT
                  value: http://influxdb-influxdb2.databases.svc.cluster.local
                - name: INFLUXDB_AUTH_TOKEN
                  valueFrom:
                    secretKeyRef:
                      key: influxdb_auth_token
                      name: fitbit-manager-f1058b
                - name: INFLUXDB_ORG
                  value: influxdata
                - name: INFLUXDB_BUCKET
                  value: fitbit_manager
                - name: OTEL_EXPORTER_OTLP_ENDPOINT
                  value: http://default-collector.opentelemetry-collector.svc.cluster.local:4317
                - name: OTEL_EXPORTER_OTLP_INSECURE
                  value: "true"
                - name: RECORD_START_DATETIME
                  value: "2022-11-01T00:00:00Z"
              image: ghcr.io/walnuts1018/fitbit-manager:1.0.4
              imagePullPolicy: IfNotPresent
              name: fitbit-manager
              ports:
                - containerPort: 8080
              resources:
                limits:
                  memory: 300Mi
                requests:
                  memory: 10Mi
          restartPolicy: OnFailure
          tolerations:
            - key: node.walnuts.dev/low-performance
              operator: Exists
  schedule: '*/15 * * * *'
  startingDeadlineSeconds: 12000
