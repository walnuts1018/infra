apiVersion: v1
data:
  trigger_and_wait_minio-biscuit-backup.sh: "#!/usr/bin/bash\n\nCRONJOB_NAME=\"minio-biscuit-backup\"\nNAMESPACE=\"minio-biscuit\"\n\nlog() {\n    local level=\"$1\"\n    local msg=\"$2\"\n    local timestamp\n    timestamp=$(date '+%Y-%m-%dT%H:%M:%S%z')\n    \n    shift 2\n    local json=\"{\\\"level\\\":\\\"$level\\\",\\\"time\\\":\\\"$timestamp\\\",\\\"msg\\\":\\\"$msg\\\"\"\n    while [[ $# -gt 0 ]]; do\n        json+=\",\\\"$1\\\":\\\"$2\\\"\"\n        shift 2\n    done\n    echo \"$json}\"\n}\n\nkubectl() {\n  command kubectl \\\n    --server=https://192.168.0.15:6443 \\\n    --token=\"$(cat /var/run/secrets/kurumi.k8s.walnuts.dev/serviceaccount/token)\" \\\n    --insecure-skip-tls-verify=true \\\n    \"$@\"\n}\n\nSTART_TIME=$(date +%s)\n\nJOB_NAME=\"$CRONJOB_NAME-manual-$START_TIME\"\n\nkubectl create job --from=cronjob/$CRONJOB_NAME \"$JOB_NAME\" -n $NAMESPACE || {\n  log \"error\" \"Failed to create Job from CronJob\" \"cronjob\" \"$CRONJOB_NAME\"\n  exit 1\n}\n\nlog \"info\" \"Waiting...\" \"job\" \"$JOB_NAME\"\n\nEND_TIME=$((START_TIME + 86400)) # Timeout: 24 hours\n\nwhile [ \"$(date +%s)\" -lt $END_TIME ]; do\n  if [ \"$(kubectl get job -n \"$NAMESPACE\" \"$JOB_NAME\" -o jsonpath='{.status.succeeded}')\" == \"1\" ]; then\n    log \"info\" \"Job completed successfully\" \"job\" \"$JOB_NAME\"\n    exit 0\n  fi\n\n  if [ \"$(kubectl get job -n \"$NAMESPACE\" \"$JOB_NAME\" -o jsonpath='{.status.failed}')\" == \"1\" ]; then\n    log \"error\" \"Job failed\" \"job\" \"$JOB_NAME\"\n    exit 1\n  fi\n\n  log \"info\" \"Job is still running... Checking again in 30 seconds.\" \"job\" \"$JOB_NAME\"\n  sleep 30\ndone\n\nlog \"error\" \"Timed out waiting for Job to complete.\" \"job\" \"$JOB_NAME\"\nexit 1\n"
  wait_minio-default-backup.sh: "#!/usr/bin/bash\n\nCRONJOB_NAME=\"minio-default-backup\"\nNAMESPACE=\"minio\"\n\nlog() {\n    local level=\"$1\"\n    local msg=\"$2\"\n    local timestamp\n    timestamp=$(date '+%Y-%m-%dT%H:%M:%S%z')\n    \n    shift 2\n    local json=\"{\\\"level\\\":\\\"$level\\\",\\\"time\\\":\\\"$timestamp\\\",\\\"msg\\\":\\\"$msg\\\"\"\n    while [[ $# -gt 0 ]]; do\n        json+=\",\\\"$1\\\":\\\"$2\\\"\"\n        shift 2\n    done\n    echo \"$json}\"\n}\n\nLATEST_JOB_NAME=$(kubectl get jobs -n \"$NAMESPACE\" \\\n  -l \"app.kubernetes.io/name=$CRONJOB_NAME\" \\\n  --sort-by=.metadata.creationTimestamp \\\n  -o jsonpath='{.items[-1].metadata.name}')\n\nif [ -z \"$LATEST_JOB_NAME\" ]; then\n  log \"error\" \"No jobs found for CronJob\" cronjob \"$CRONJOB_NAME\"\n  exit 1\nfi\n\nlog info \"Waiting...\" \"job\" \"$LATEST_JOB_NAME\"\n\nSTART_TIME=$(date +%s)\nEND_TIME=$((START_TIME + 86400)) # Timeout: 24 hours\n\nwhile [ \"$(date +%s)\" -lt $END_TIME ]; do\n  if [ \"$(kubectl get job -n \"$NAMESPACE\" \"$LATEST_JOB_NAME\" -o jsonpath='{.status.succeeded}')\" == \"1\" ]; then\n    log info \"Job completed successfully\" \"job\" \"$LATEST_JOB_NAME\"\n    exit 0\n  fi\n\n  if [ \"$(kubectl get job -n \"$NAMESPACE\" \"$LATEST_JOB_NAME\" -o jsonpath='{.status.failed}')\" == \"1\" ]; then\n    log error \"Job failed\" \"job\" \"$LATEST_JOB_NAME\"\n    exit 1\n  fi\n\n  log info \"Job is still running... Checking again in 30 seconds.\" \"job\" \"$LATEST_JOB_NAME\"\n  sleep 30\ndone\n\nlog error \"Timed out waiting for Job '$LATEST_JOB_NAME' to complete.\"\nexit 1\n"
kind: ConfigMap
metadata:
  labels:
    app: minio-biscuit-backup-trigger
    app.kubernetes.io/name: minio-biscuit-backup-trigger
  name: minio-biscuit-backup-trigger-script-c10bb3
  namespace: minio-biscuit
