apiVersion: apps/v1
kind: Deployment
metadata:
  name: archivebox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: archivebox
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: archivebox
    spec:
      securityContext:
        fsGroup: 991
        fsGroupChangePolicy: "OnRootMismatch"
      initContainers:
        - name: archivebox-init
          image: archivebox/archivebox:0.7.2 # {"$imagepolicy": "archivebox:archivebox"}
          imagePullPolicy: IfNotPresent
          command:
            - pnpm
            - run
            - init
          volumeMounts:
            - name: archivebox-data
              mountPath: /data
      containers:
        - name: archivebox
          image: archivebox/archivebox:0.7.2 # {"$imagepolicy": "archivebox:archivebox"}
          imagePullPolicy: IfNotPresent
          args: ["server"]
          ports:
            - containerPort: 8000
              protocol: TCP
              name: http
          volumeMounts:
            - name: archivebox-data
              mountPath: /data
          resources: {}
      volumes:
        - name: archivebox-data
          persistentVolumeClaim:
            claimName: archivebox
