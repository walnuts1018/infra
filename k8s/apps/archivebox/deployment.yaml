apiVersion: apps/v1
kind: Deployment
metadata:
  name: archivebox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: archivebox
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: archivebox
    spec:
      initContainers:
        - name: archivebox-init
          image: archivebox/archivebox:0.7.2 # {"$imagepolicy": "archivebox:archivebox"}
          imagePullPolicy: IfNotPresent
          args:
            - init
            - "--setup"
          volumeMounts:
            - name: archivebox-data
              mountPath: /data
        # - name: archivebox-config
        #   image: archivebox/archivebox:0.7.2 # {"$imagepolicy": "archivebox:archivebox"}
        #   imagePullPolicy: IfNotPresent
        #   command:
        #     - sh
        #     - -c
        #     - |
        #       archivebox config --set PUBLIC_ADD_VIEW=True;
        #       archivebox config --set PUBLIC_SNAPSHOTS=True;
        #       archivebox config --set PUBLIC_INDEX=True;
        #   securityContext:
        #     runAsUser: 911
        #     runAsGroup: 911
        #   volumeMounts:
        #     - name: archivebox-data
        #       mountPath: /data
      containers:
        - name: archivebox
          image: archivebox/archivebox:0.7.2 # {"$imagepolicy": "archivebox:archivebox"}
          imagePullPolicy: IfNotPresent
          args: ["server"]
          ports:
            - containerPort: 8000
              protocol: TCP
              name: http
          volumeMounts:
            - name: archivebox-data
              mountPath: /data
          resources:
            requests:
              cpu: 100m
              memory: 100Mi
            limits:
              cpu: 500m
              memory: 500Mi
      volumes:
        - name: archivebox-data
          persistentVolumeClaim:
            claimName: archivebox
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 1
          preference:
            matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                  - amd64
