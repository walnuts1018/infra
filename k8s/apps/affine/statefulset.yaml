apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: affine
    app.kubernetes.io/name: affine
  name: affine
  namespace: affine
spec:
  replicas: 1
  selector:
    matchLabels:
      app: affine
      app.kubernetes.io/name: affine
  serviceName: affine
  template:
    metadata:
      labels:
        app: affine
        app.kubernetes.io/name: affine
    spec:
      containers:
        - command:
            - sh
            - -c
            - node ./dist/index.js
          env:
            - name: AFFINE_SERVER_HOST
              value: affine.walnuts.dev
            - name: AFFINE_SERVER_PORT
              value: "3010"
            - name: AFFINE_SERVER_EXTERNAL_URL
              value: https://affine.walnuts.dev
            - name: NODE_OPTIONS
              value: --import=./scripts/register.js
            - name: AFFINE_CONFIG_PATH
              value: /root/.affine/config
            - name: REDIS_SERVER_HOST
              value: affine-redis
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  key: postgres-url
                  name: affine-minio
            - name: NODE_ENV
              value: production
            - name: DEPLOYMENT_TYPE
              value: selfhosted
            - name: MAILER_HOST
              value: smtp.resend.com
            - name: DEV_SERVER_URL
              value: https://affine.walnuts.dev
            - name: MAILER_PORT
              value: "587"
            - name: MAILER_USER
              value: resend
            - name: MAILER_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: mailer-password
                  name: affine-minio
            - name: MAILER_SENDER
              value: affine@resend.walnuts.dev
            - name: OAUTH_OIDC_ISSUER
              value: https://auth.walnuts.dev
            - name: OAUTH_OIDC_CLIENT_ID
              value: "296071951179383022"
            - name: OAUTH_OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  key: oidc-client-secret
                  name: affine-minio
          image: ghcr.io/toeverything/affine-graphql:stable-1623f5d
          livenessProbe:
            failureThreshold: 1
            httpGet:
              path: /info
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          name: affine
          ports:
            - containerPort: 3010
              name: http
            - containerPort: 5555
              name: prisma
          readinessProbe:
            failureThreshold: 1
            httpGet:
              path: /info
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 2m
              memory: 120Mi
          volumeMounts:
            - mountPath: /root/.affine/storage
              name: affine-storage
            - mountPath: /root/.affine/config
              name: affine-config
            - mountPath: /root/.affine/config/affine.js
              name: affine-config-affine-js
              readOnly: true
              subPath: affine.js
            - mountPath: /usr/local/share/.cache
              name: usr-local-share-cache
            - mountPath: /tmp
              name: tmp
      initContainers:
        - command:
            - sh
            - -c
            - node ./scripts/self-host-predeploy
          env:
            - name: AFFINE_SERVER_HOST
              value: affine.walnuts.dev
            - name: AFFINE_SERVER_PORT
              value: "3010"
            - name: AFFINE_SERVER_EXTERNAL_URL
              value: https://affine.walnuts.dev
            - name: NODE_OPTIONS
              value: --import=./scripts/register.js
            - name: AFFINE_CONFIG_PATH
              value: /root/.affine/config
            - name: REDIS_SERVER_HOST
              value: affine-redis
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  key: postgres-url
                  name: affine-minio
            - name: NODE_ENV
              value: production
            - name: DEPLOYMENT_TYPE
              value: selfhosted
            - name: MAILER_HOST
              value: smtp.resend.com
            - name: DEV_SERVER_URL
              value: https://affine.walnuts.dev
            - name: MAILER_PORT
              value: "587"
            - name: MAILER_USER
              value: resend
            - name: MAILER_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: mailer-password
                  name: affine-minio
            - name: MAILER_SENDER
              value: affine@resend.walnuts.dev
            - name: OAUTH_OIDC_ISSUER
              value: https://auth.walnuts.dev
            - name: OAUTH_OIDC_CLIENT_ID
              value: "296071951179383022"
            - name: OAUTH_OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  key: oidc-client-secret
                  name: affine-minio
          image: ghcr.io/toeverything/affine-graphql:stable-1623f5d
          name: affine-init
          resources:
            limits:
              memory: 512Mi
            requests:
              memory: 360Mi
          volumeMounts:
            - mountPath: /root/.affine/storage
              name: affine-storage
            - mountPath: /root/.affine/config
              name: affine-config
            - mountPath: /root/.affine/config/affine.js
              name: affine-config-affine-js
              readOnly: true
              subPath: affine.js
            - mountPath: /usr/local/share/.cache
              name: usr-local-share-cache
            - mountPath: /tmp
              name: tmp
      volumes:
        - configMap:
            items:
              - key: affine.js
                path: affine.js
            name: affine-fc340a
          name: affine-config-affine-js
        - name: affine-storage
          persistentVolumeClaim:
            claimName: affine-storage
        - emptyDir: {}
          name: affine-config
        - emptyDir: {}
          name: usr-local-share-cache
        - emptyDir: {}
          name: tmp
