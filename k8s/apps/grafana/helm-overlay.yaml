---
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: repo
spec:
  interval: 1m
  url: https://grafana.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: release
spec:
  chart:
    spec:
      chart: grafana
      version: 6.49.0
      sourceRef:
        kind: HelmRepository
        name: grafana-repo
  values:
    rbac:
      pspEnabled: false
    testFramework:
      enabled: false
    persistence:
      enabled: true
      storageClassName: longhorn
    service:
      type: ClusterIP

    admin:
      existingSecret: "grafana-secret"
      userKey: admin-username
      passwordKey: admin-password

    extraSecretMounts:
    - name: auth-generic-oauth-secret
      secretName: grafana-secret
      mountPath: /etc/secrets/auth_generic_oauth
      readOnly: true

    grafana.ini:
      server:
        domain: grafana.walnuts.dev
        root_url: https://grafana.walnuts.dev/
      auth:
        disable_login_form: true
      auth.basic:
        enabled: false
      auth.generic_oauth:
        enabled: true
        client_id: grafana
        client_secret: $__file{/etc/secrets/auth_generic_oauth/client_secret}
        scopes: openid email profile offline_access roles
        email_attribute_path: email
        login_attribute_path: profile.username
        name_attribute_path: profile.username
        auth_url: https://auth.walnuts.dev/realms/master/protocol/openid-connect/auth
        token_url: https://auth.walnuts.dev/realms/master/protocol/openid-connect/token
        api_url: https://auth.walnuts.dev/realms/master/protocol/openid-connect/userinfo
        #role_attribute_strict: true
        role_attribute_path: contains(roles[*], 'admin') && 'Admin' || 'Viewer'
        use_pkce: true