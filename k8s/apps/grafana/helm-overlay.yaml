---
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: repo
spec:
  interval: 1m
  url: https://grafana.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: release
spec:
  chart:
    spec:
      chart: grafana
      version: 6.59.0
      sourceRef:
        kind: HelmRepository
        name: grafana-repo
  values:
    resources:
      limits:
        cpu: 200m
        memory: 200Mi
      requests:
        cpu: 5m
        memory: 64Mi
    rbac:
      pspEnabled: false
    testFramework:
      enabled: false
    persistence:
      enabled: true
      storageClassName: longhorn
    service:
      type: ClusterIP

    admin:
      existingSecret: "grafana-secret"
      userKey: admin-username
      passwordKey: admin-password

    extraSecretMounts:
      - name: auth-generic-oauth-secret
        secretName: grafana-secret
        mountPath: /etc/secrets/auth_generic_oauth
        readOnly: true

    grafana.ini:
      server:
        domain: grafana.walnuts.dev
        root_url: https://grafana.walnuts.dev/
      log:
        level: debug
      auth:
        #disable_login_form: true
      auth.basic:
        enabled: false
      auth.generic_oauth:
        enabled: true
        client_id: 237187024069656922@walnuts.dev
        client_secret: $__file{/etc/secrets/auth_generic_oauth/client_secret}
        scopes: openid email profile offline_access urn:zitadel:iam:org:projects:roles
        email_attribute_path: email
        login_attribute_path: preferred_username
        name_attribute_path: preferred_username
        auth_url: https://auth2.walnuts.dev/oauth/v2/authorize
        token_url: https://auth2.walnuts.dev/oauth/v2/token
        api_url: https://auth2.walnuts.dev/oidc/v1/userinfo
        #role_attribute_strict: true
        role_attribute_path: urn:zitadel:iam:org:project:roles[0].grafana-admin!=null && 'GrafanaAdmin' || urn:zitadel:iam:org:project:roles[0].grafana-editor!=null && 'Editor' || urn:zitadel:iam:org:project:roles[0].grafana-viewer!=null && 'Viewer'
        allow_assign_grafana_admin: true
        use_pkce: true
