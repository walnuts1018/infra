apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
    name: k8s-deployment
spec:
    config:
        exporters:
            otlp/default:
                endpoint: default-collector.opentelemetry-collector.svc.cluster.local:4317
                tls:
                    insecure: true
        processors:
            batch:
                send_batch_size: 10000
                timeout: 10s
            k8sattributes:
                auth_type: serviceAccount
                extract:
                    metadata:
                        - k8s.cluster.uid
                pod_association:
                    - sources:
                        - from: resource_attribute
                          name: k8s.pod.ip
                    - sources:
                        - from: resource_attribute
                          name: k8s.pod.uid
                    - sources:
                        - from: connection
            memory_limiter:
                check_interval: 1s
                limit_mib: 2000
                spike_limit_percentage: 15
        receivers:
            k8s_cluster:
                allocatable_types_to_report:
                    - cpu
                    - memory
                auth_type: serviceAccount
                node_conditions_to_report:
                    - Ready
                    - MemoryPressure
                resource_attributes:
                    k8s.container.status.last_terminated_reason:
                        enabled: true
                    k8s.deployment.name:
                        enabled: true
        service:
            pipelines:
                metrics:
                    exporters:
                        - otlp/default
                    processors:
                        - memory_limiter
                        - batch
                        - k8sattributes
                    receivers:
                        - k8s_cluster
    env:
        - name: K8S_NODE_IP
          valueFrom:
            fieldRef:
                fieldPath: status.hostIP
    image: otel/opentelemetry-collector-k8s
    managementState: managed
    mode: deployment
    replicas: 1
    serviceAccount: otel-collector

---
